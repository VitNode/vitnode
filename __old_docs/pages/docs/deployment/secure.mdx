import { Steps } from "nextra/components";
import { Tabs } from "nextra/components";
import Image from "next/image";
import fail2banStatus from "@/assets/setup/secure/fail2ban-status.png";
import generateSshTermius from "@/assets/setup/secure/generate-ssh-termius.png";
import formGenerateSshTermius from "@/assets/setup/secure/form-generate-ssh-termius.png";

# Secure Server

Secure in the most important part of the server. In this guide, we will cover the basic steps to secure your server.

## Fail2Ban

<Tabs items={['Manual', 'Fast']}>
  <Tabs.Tab>
   <Steps>

### Install Fail2Ban

```bash
apt install fail2ban -y
```

### Config Fail2Ban

```bash
echo -e "[sshd]\nbackend=systemd\nenabled=true" | tee /etc/fail2ban/jail.local
```

### Enable Fail2Ban

```bash
systemctl enable fail2ban
```

### Start Fail2Ban

```bash
systemctl start fail2ban
```

   </Steps>
  </Tabs.Tab>

    <Tabs.Tab>

```bash
apt install fail2ban -y &&\
 echo -e "[sshd]\nbackend=systemd\nenabled=true" | tee /etc/fail2ban/jail.local &&\
 systemctl enable fail2ban &&\
 systemctl start fail2ban
```

  </Tabs.Tab>
</Tabs>

### Verify status of Fail2Ban

```bash
systemctl status fail2ban
```

Status should be `Active: active (running)`.

<Image src={fail2banStatus} alt="fail2ban status" />

## Disable IPv6

<Steps>

### Open the Configuration File

```bash
nano /etc/sysctl.conf
```

### Add the following lines to the file

```bash
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
```

### Save and Exit

Press `Ctrl + X`, then `Y`, then `Enter` to save and exit the file.

### Apply the changes

```bash
sysctl -p
```

### Verify the changes

```bash
cat /proc/sys/net/ipv6/conf/all/disable_ipv6
```

If you see `1`, then IPv6 has been disabled.

</Steps>

## Create a non-root user

In this part of the guide, we will create a new user and give them sudo privileges. Please replace `{username}` with the name of the user you would like to create.

<Steps>

### Create a new user

```bash
adduser {username}
```

### Add user to Sudo Group

```bash
usermod -aG sudo {username}
```

</Steps>

## Generate SSL

For more secure connections, you can generate an SSL certificate. We using [Termius](https://termius.com/) to generate the certificate.

<Steps>

### Generate SSH Key

In [Termius](https://termius.com/) open "Settings => `Keychain`" and click on the "Generate" button on `SSH Key` section.

<Image src={generateSshTermius} alt="Keychain Settings in Termius" />

### Fill the form

<Image
  src={formGenerateSshTermius}
  className="max-w-xs"
  alt="Form Keychain in Termius"
/>

Save `public key` generated by Termius.

### Create SSL folder

Open the terminal your server and create a folder for the SSL certificate.

```bash
mkdir /home/{username}/.ssh && cd /home/{username}/.ssh
```

### Create `authorized_keys` file

```bash
nano authorized_keys
```

### Paste the public key

Now paste the public key generated by Termius into the `authorized_keys` file.

### Save and Exit

Press `Ctrl + X`, then `Y`, then `Enter` to save and exit the file.

### Restart SSH Service

```bash
systemctl restart sshd
```

### Test the connection

Now try to connect to your server using the private key and the username you created `without password`. If you can connect, then the SSL certificate has been successfully generated.

From here we will be using the new user for the rest of the guide.

</Steps>

## Edit Configuration File

<Steps>

### Open the Configuration File

```bash
sudo nano /etc/ssh/sshd_config
```

### Change the Default SSH Port

Locate the line that reads `#Port 22` and change it to `Port X` where is is a different port number.

### Disable Root Login

Locate the line that reads `PermitRootLogin yes` and change it to `PermitRootLogin no`.

### Disable Password Authentication

Locate the line that reads `#PasswordAuthentication yes` and change it to `PasswordAuthentication no`.

### Save and Exit

Press `Ctrl + X`, then `Y`, then `Enter` to save and exit the file.

</Steps>

## Firewall (UFW)

<Tabs items={['Manual', 'Fast']}>

<Tabs.Tab>

<Steps>

### Install

```bash
sudo apt install ufw -y
```

### Deny all incoming connections

```bash
sudo ufw default deny incoming
```

### Allow all outgoing connections

```bash
sudo ufw default allow outgoing
```

### Allow SSH

```bash
sudo ufw allow ssh
```

### Allow Nginx

```bash
sudo ufw allow 'Nginx Full'
```

### Allow the new SSH port

```bash
sudo ufw allow {port}
```

Replace `{port}` with the port number you set in the SSH configuration file.

### Enable

```bash
sudo ufw enable
```

</Steps>

</Tabs.Tab>

<Tabs.Tab>

```bash
sudo apt install ufw -y &&\
 sudo ufw default deny incoming &&\
 sudo ufw default allow outgoing &&\
 sudo ufw allow ssh &&\
 sudo ufw allow 'Nginx Full' &&\
 sudo ufw allow {port} &&\
 sudo ufw enable
```

Replace `{port}` with the port number you set in the SSH configuration file.

</Tabs.Tab>

</Tabs>

## Restart SSH Service

```bash
sudo systemctl restart sshd
```

## Set permissions

```bash
git config --global --add safe.directory /home/vitnode &&\
 sudo chmod 775 /home/vitnode &&\
 sudo chown -R {username}:{username} /home/vitnode
```

Replace `{username}` with your username.
